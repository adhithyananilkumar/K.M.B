# Admission Form Revamp

This document describes the migration strategy, database shape, and rollout steps for the new canonical Admission Form.

## Migration Options

Option A: Use `admission_number` as PRIMARY KEY
- Pros: Natural key aligns with business identifier; URLs and integrations can use admission number directly.
- Cons: Requires updating all FKs/pivots that currently point to `inmates.id`.
- Steps:
  1. Add `admission_number` (unique, not null) and populate for all existing rows with a backfill script.
  2. Add new FKs to use `admission_number` or migrate dependent tables to reference the new PK.
  3. Drop `id` or keep as surrogate non-PK if needed.

Option B (Recommended incremental): Keep `id` as surrogate PK; make `admission_number` unique and primary external identifier.
- Pros: Safer migration, minimal disruption to existing relationships.
- Cons: Two identifiers exist; ensure developers use `admission_number` in business logic and UI.
- Steps: Apply the included migration which adds `admission_number` as unique and indexes. No FK rewrites needed.

## Added Columns

See migration `2025_09_26_000001_update_inmates_admission_revamp.php` for the full list: demographics, guardians, education, documents (JSON), `admitted_by`, `verified_by`, `room_location_id`, `consent_signed_at`, soft deletes, and indices.

## Admission Number Format

`ADM{YYYY}{6digits}` â€” generated by `App\Services\AdmissionNumberGenerator` with DB uniqueness check and retry.

## File Storage

All inmate files now saved under `storage/app/public/{ENV}/inmates/{admission_number}/photos|documents`. Ensure `php artisan storage:link` is run.

## Rollback

The migration drops only newly added columns when rolling back. Data in JSON `documents` will be retained only if column remains. Back up before rollback.

## Checklist

- [ ] Run migrations
- [ ] Ensure `FILES_BASE_PREFIX` is set for environment separation (defaults to app env)
- [ ] Run `php artisan storage:link`
- [ ] Verify room picker API returns `occupied` and `status`
- [ ] Verify consent print endpoint (TBD) returns bilingual PDF
